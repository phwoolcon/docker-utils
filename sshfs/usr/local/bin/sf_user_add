#!/usr/bin/env bash

USERNAME=$1
DEPT=$2
PUB_KEY=$3

HOME_DIR="/data/users/${USERNAME}"
DEPT_DIR="/data/depts/${DEPT}"
SSHFS_DIR="/sshfs/${USERNAME}"

adduser -D -G sshfs -h "${HOME_DIR}" "${USERNAME}"
passwd -u "${USERNAME}"

addgroup "${USERNAME}" sshfs

mkdir -p "${HOME_DIR}/.ssh" "${HOME_DIR}/me" "${DEPT_DIR}"
mkdir -p "${SSHFS_DIR}/0-share" "${SSHFS_DIR}/1-dept" "${SSHFS_DIR}/2-me"
echo "${PUB_KEY}" > "${HOME_DIR}/.ssh/authorized_keys"

chown ${USERNAME}:sshfs "${HOME_DIR}/me/"
chmod g+w "${HOME_DIR}/me/"
chmod g+s "${HOME_DIR}/me/"

chmod g+w /data/depts/*
chmod g+s /data/depts/*

cp -a /etc/group /data/etc/group
cp -a /etc/passwd /data/etc/passwd
cp -a /etc/shadow /data/etc/shadow

sf_gen_user_fstab "${USERNAME}" "${DEPT}"
sf_gen_fstab_and_mount
